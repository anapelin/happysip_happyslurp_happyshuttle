---
title: "Project"
output: html_document
date: "2023-10-09"
---

```{r setup, include=FALSE}
library(GISTools)
library(raster)
library(tmap)
library(rgdal) 
library(maptools) 
library(sp)
library(sf)
library(tidyverse)
library(rgeos)
library(ggplot2)
library(psych)
library(spatstat)
library(spdep)
library(jsonlite)
library(dplyr)
```

```{r data, include=FALSE}

# 2.1 Basemap - Singapore Subzones (Polygons Vectors)
subzones <- st_read(dsn = "dataset/basemap", layer = "MP14_SUBZONE_NO_SEA_PL")

# 2.2 Nightlife (Bars + Clubs) Data (Points Vectors)
rawdata_bars <- fromJSON("dataset/besttime/bars.json", flatten=TRUE)
rawdata_clubs <- fromJSON("dataset/besttime/clubs.json", flatten=TRUE)
relevant_columns <- c("venue_lat", "venue_lon", "venue_name")
bars <- rawdata_bars$venues[relevant_columns]
clubs <- rawdata_clubs$venues[relevant_columns]
# Nightlife DataFrame: lat, lng, name of place, crowd density
nightlife <- rbind(bars, clubs)
new_column_names <- c("lat", "lng", "name")
nightlife <- setNames(nightlife, new_column_names)
nightlife_coordinates <- cbind(nightlife$lng, nightlife$lat) 

# 2.3 Midnight Restaurants Crowd Density Data
rawdata_restaurants <- read.csv("dataset/besttime/restaurants.csv")
# Restaurant DataFrame: lat, lng, name of restaurant, is_midnight, crowd density on fri and sat
restaurants <- rawdata_restaurants %>% dplyr::select(name, lat, lon, midnight_restaurant, fri_cd, sat_cd)
restaurants_coordinates <- cbind(restaurants$lon, restaurants$lat)

# 2.4 Population - Youth Data (Points Vectors)
population <- read.csv("dataset/filteredSG_population_density.csv")
yth_data <- read.csv("dataset/filteredSG_population_density.csv") %>% dplyr::select(longitude, latitude, youth)
coordinates(population) <- ~longitude+latitude

# 2.5 HDB Data (Points Vectors)
hdb <- read.csv("dataset/hdb.csv") %>% mutate(addr = paste(blk_no,street)) %>% dplyr::select(addr,lat,lng)

# 2.6 Bus Stops Data (Points Vectors)
bus_data <- data.frame()
for(i in 0:10) {
  file_name <- paste0("dataset/busstops/response(", i, ").json")
  # Handle the case for response.json (without the index)
  if(i == 0) {
    file_name <- "dataset/busstops/response.json"
  }
  json_read <- fromJSON(file_name, flatten = TRUE)
  bus_data <- rbind(bus_data, json_read$value)
}

```

## 

```{r maps}
# 3. Preprocessing Data to DataFrames/Vectors/Rasters
# 3.1 Nightlife Locations

# Create a Nightlife Spatial Points DataFrame
nightlife_sp_data <- SpatialPointsDataFrame(nightlife_coordinates, data = data.frame(nightlife), proj4string = CRS("+proj=longlat +datum=WGS84"))
nightlife_sf <- st_as_sf(nightlife_sp_data) 
nightlife_sf <- st_transform(nightlife_sf, crs=st_crs(subzone)) # project to basemap's CRS

# Convert to Nightlife Point Pattern dataset
nightlife_ppp <- as.ppp(nightlife_sf)

# Combine with subzones for Nightlife Density DataFrame
nightlife_subzone <- st_join(subzones, nightlife_sf)
nightlife_density_subzone <- nightlife_subzone %>%
  group_by(SUBZONE_N) %>%
  summarize(bar_density = sum(!is.na(name)))

# 3.2 Midnight Restaurants

# Create a Restaurants Spatial Points DataFrame
restaurants_sp_data <- SpatialPointsDataFrame(restaurants_coordinates, data = data.frame(restaurants), proj4string = CRS("+proj=longlat +datum=WGS84"))
restaurants_sf <- st_as_sf(restaurants_sp_data)
restaurants_sf <- st_transform(restaurants_sf, crs = st_crs(subzones)) # project to basemap's CRS

# Convert to Restaurants Point Pattern dataset
restaurants_ppp <- as.ppp(restaurants_sf)

# Combine with subzones for Restaurants Density DataFrame
restaurants_subzone <- st_join(subzones, restaurants_sf)
restaurants_density_subzone <- restaurants_subzone %>%
  group_by(SUBZONE_N) %>%
  summarize(restaurants_density = sum(!is.na(name)))

# 3.3 Population - Youth Density

# Create a Population Raster Dataset
r <- raster(extent(population), resolution=c(0.001, 0.001)) # Here 0.001 is an example resolution. Adjust as necessary.
under5_raster <- rasterize(population, r, field="under5", fun=mean)

plot(under5_raster)

# Convert to Population Point Pattern dataset
ppp_data <- as.ppp(population)
plot(ppp_data)
# Create a Youth Spatial Polygon DataFrame
yth_sf <- st_as_sf(yth_data, coords = c("longitude", "latitude"), crs = 4326)
yth_sf <- st_transform(yth_sf, crs = st_crs(subzones)) # project to basemap's CRS

# 3.4 HDB


# 3.5 Bus Stops
bus_sf <- st_as_sf(bus_data, coords = c("Longitude", "Latitude"), crs = 4326)
bus_sf <- st_transform(bus_sf, crs = st_crs(subzones)) # project to basemap's CRS


```

ssdsd
```{r spatialKDE}
combined_data <- st_join(subzones, nightlife_sf)
View(combined_data)
density_count <- combined_data %>%
  group_by(SUBZONE_N) %>%
  summarize(bar_density = sum(!is.na(name)))
density_count
```
## Including Plots

You can also embed plots, for example:

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
